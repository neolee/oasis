下一步我们准备在现有能力（L1、L2及L3的一部分）基础上创建一个 TUI 应用，以提供更多高级功能。

## 项目目标与依赖

将目前项目 component 之一的 `oasis-cli` 的 `source-dirs` 从 `app` 改为 `cli`；增加一个 `executable` 命名为 `oasis-tui`，其源目录设为 `tui`，TUI 源代码置于此。

从一般角度考虑，Haskell 最主要的 TUI 库 [brick](https://github.com/jtdaugherty/brick) 及其第三方扩展 [brick-panes](https://github.com/kquick/brick-panes)、[brick-skylighting](https://github.com/jtdaugherty/brick-skylighting)，以及语法高亮库 [skylighting](https://github.com/jgm/skylighting) 是需要重点考虑的核心依赖。

## 设计理念：TUI 与 CLI 的核心差异

TUI 不是 CLI 的简单包装，而是在交互体验上的全面升级：

1. **显示更漂亮清晰**：语法高亮、结构化显示（JSON/Markdown）、消息历史可视化、流式输出实时渲染。
2. **输入体验更好**：多行编辑、方向键移动、拷贝粘贴、对话框参数输入、自动补全。
3. **更多高级功能**：Verbose Mode（消息历史编辑）、Advanced Mode（请求前确认）、右侧边栏高级面板。

TUI 保持与 CLI 相同的分层架构（L1-L3），仅作为 L4 表示层提供更优秀的用户体验。

## 非功能需求

- TUI 应划分为几个主要窗体 *pane*，可以用快捷键（通常是一个数字或字母按键）切换到不同区域。
- 使用方向键导航，使用 Enter 键选择或确认，使用 ESC 键取消或放弃。
- 需要用户输入文本时要暂停处理界面快捷键处理，所以要有进入退出编辑状态的方法；应提供方便易用的输入体验如方向键移动、拷贝粘贴、多行文本输入等。
- 对需要显示 Markdown、JSON 等文本或数据或源代码的窗口，应该提供语法高亮和尽可能美观易读的显示格式。
- 尽可能兼容宽度 80 字符以上、高度 40 字符以上的终端窗口。

## 功能需求

- 大语言模型（LLM）选择：通过 `provider` 和 `model` 选择模型，支持列表选择和手工输入，兼顾方便和灵活。
- 可以从列表中选择一个 *runner* 来执行；可以方便地设置参数；最好有个方便的方法，以后增加了新的 *runner* 也能自动加载到可选列表。
- 高级开关：对任何 *runner* 都有效：
  - Verbose Mode：开启后在右侧边栏显示会话中消息历史 *message list*，可以选择任意一项查看、修改、删除，也可以手工增加 *message* 项，类似 CLI app 中 Chat runner 支持的 `/show` `/system` `/insert` `/update` `/delete` 等命令的功能。
  - Advanced Mode：开启后每次发送请求到 LLM 之前暂停，在右侧边栏允许用户查看和修改传送的 *message list* 和其他参数。

## 详细设计

### 布局设计
采用**左右边栏加中央主区域加底部状态栏**的布局，右侧边栏用于高级模式（稍后实现），对话框用于一次性或不常用的数据输入：

```
┌─────┬────────────────────────────┬─────┐
│     │                            │     │
│  左 │      中央主区域            │  右 │
│  侧 │    (核心交互/显示)         │  侧 │
│  边 │                            │  边 │
│  栏 │                            │  栏 │
│     │                            │     │
├─────┴────────────────────────────┴─────┤
│  底部状态栏/日志                       │
└────────────────────────────────────────┘
```

**窗体划分**：

1. **左侧边栏**（宽度 20%，固定）
   - Provider 列表（从 `providers.toml` 加载）
   - Model 列表（基于所选 provider 的 `model_ids`，含"手动输入…"选项）
   - Runner 列表（能否实现动态发现所有 `Oasis.Runner.*` 模块？）

2. **中央主区域**（宽度 60%，动态）
   - **非 Chat Runner**：输出显示区域（支持语法高亮的 JSON/Markdown）
   - **Chat Runner**：
     ```
     ┌─────────────────────────────────────┐
     │ 消息历史 (可滚动 viewport)          │
     │  [user] Hello...                    │
     │  [assistant] Hi...                  │
     ├─────────────────────────────────────┤
     │ 输入区域 (多行编辑框)               │
     │ >>>                                 │
     └─────────────────────────────────────┘
     ```

3. **右侧边栏**（宽度 20%，初始隐藏或留空）
   - 包含上下两个的窗体：
     1. **消息历史列表**（Verbose Mode）：显示当前会话的所有消息，支持选择、编辑、删除
     2. **消息详情/参数确认**（Advanced Mode）：显示选中消息的详细内容，或发送请求前的参数确认面板
   - 默认可能折叠或显示辅助信息，高级模式启用时自动显示

4. **底部状态栏**（高度 10-15%）
   - 状态信息：当前 provider/model/runner/API 状态
   - 操作反馈：请求进度、错误信息
   - 快捷键提示：当前可用操作

### 快捷键设计
**窗体激活**（全局生效，直接切换到对应窗体）：
- `P`：跳转到 Provider 列表（左侧边栏）
- `M`：跳转到 Model 列表（左侧边栏）
- `R`：跳转到 Runner 列表（左侧边栏）
- `V`：跳转到输出显示区域（中央主区域）
- `E`：跳转到输入区域（中央主区域，Chat runner 专用）
- `L`：跳转到消息历史列表（右侧边栏，Verbose Mode）
- `D`：跳转到消息详情/参数确认（右侧边栏，Advanced Mode）
- `ESC`：取消当前操作/请求，关闭对话框
- `F1`：显示帮助页面
- `F2`：切换 Verbose Mode
- `F3`：切换 Advanced Mode
- `Q`：退出应用

**非文本输入窗体**（适用于列表类窗体：Provider/Model/Runner/消息历史列表等）：
- `↑/↓`：上下移动选择项
- `Enter`：确认选择（如选择 provider 后加载 models）
- `ESC`：退出当前窗体或取消选择
- `字母/数字`：快速跳转到匹配项
- `空格`：切换选中状态（如有多选场景）
- `Tab`/`Shift+Tab`：在列表项内字段间切换（如有子字段）

**文本输入窗体**（适用于文本输入类窗体：主输入区域、对话框输入框）：
- 尽量遵循默认控件的行为标准，下列仅供参考。
- 标准文本输入：字母、数字、符号
- `ESC`：取消输入/退出编辑模式
- `←`/`→`：光标左右移动
- `↑`/`↓`：光标上下移动（多行时）
- `Ctrl+J`：插入新行（代替回车）
- `Enter`：完成输入/发送消息（根据上下文）

**输出显示窗体**（只读显示）：
- 尽量遵循默认控件的行为标准，下列仅供参考。
- `↑`/`↓`：滚动查看历史输出

**全局操作**（任何焦点下生效）：
- `ESC`：通用取消/返回
- `Q`：退出应用
- `F1`：显示帮助
- `F2`/`F3`：切换高级模式

### 实施计划

#### 阶段 1：基础框架
1. 集成 `Oasis.Config` 加载 providers，显示在左侧列表

**交付物**：可运行的空 TUI，显示基本布局和 provider 列表

#### 阶段 2：核心交互与 Basic Runner
1. 实现左侧面板完整功能：provider/model/runner 列表交互
2. 实现中央区域内容展示，支持 JSON 和 Markdown 语法高亮
3. 集成 Basic runner 执行和结果显示
4. 实现对话框系统基础框架，支持弹出对话框输入参数

**交付物**：可选择 provider/model/runner、执行 basic runner 并查看美观输出、可通过对话框调整参数的 TUI

#### 阶段 3：其他 Runner
1. 实现其他 runner（Embeddings、Structured、ToolCalling 等）

**交付物**：生产可用的 TUI，支持除 Chat 以外所有 runner

#### 阶段 4：Chat Runner 与高级功能
1. 实现 Chat runner 界面：消息历史显示、输入框多行编辑
2. 实现流式输出渲染，支持 thinking tokens
3. Verbose Mode：消息历史列表及编辑
4. Advanced Mode：请求拦截即 context 修改

**交付物**：功能完整的 Chat runner TUI，支持多轮对话、流式输出和高级模式

### 验证标准
每个阶段完成后应通过以下验证：
1. **编译通过**：`stack build` 无错误
2. **类型检查**：HLS 诊断无问题
3. **基本功能**：阶段目标功能可交互操作
4. **错误处理**：API 错误、网络问题等有合理反馈
5. **快捷键**：定义的快捷键工作正常

## Chat 与高级模式详细设计

本节细化 Chat runner + Verbose/Debug（Advanced）模式的 UI 布局、交互与实施准备。以下是**明确优先级**的功能范围：

- **Chat runner**：历史消息对齐、选择复制为主功能；“重发上一条消息”延后。
- **Verbose mode**：支持消息增删改与列表查看为主功能；批量删除、system 模板作为增强。
- **Debug mode**：发送前可编辑 JSON 为主功能；展示更详细请求信息作为增强。

### 一、界面布局详细设计

#### 1) Chat runner 主界面（中央主区域）
```
┌──────────────────────────────────────────────────────────────────┐
│ 消息历史 viewport（可滚动，Markdown 渲染）                        │
│                                                                  │
│  ┌─────────────── 用户消息（右对齐） ────────────────┐            │
│  │ 用户内容（Markdown 渲染）                        │            │
│  └──────────────────────────────────────────────────┘            │
│                                                                  │
│  ┌────────────── 助手消息（左对齐） ────────────────┐             │
│  │ 助手内容（Markdown 渲染）                        │             │
│  └─────────────────────────────────────────────────┘             │
│                                                                  │
│  [↑/↓ 或 PgUp/PgDn 滚动历史；支持选择复制]                        │
├──────────────────────────────────────────────────────────────────┤
│ 输入区（多行编辑框）                                             │
│ > 你可以在这里输入多行文本…                                      │
└──────────────────────────────────────────────────────────────────┘
```

**说明**
- 对齐：用户消息右对齐、assistant 左对齐。消息容器宽度占 70–80% 主区域。
- 选择复制：在历史 viewport 中允许选择文本并复制到剪贴板。
- 滚动：历史 viewport 与输入区分离，历史滚动不影响输入。

#### 2) Verbose mode 右侧边栏（消息列表 + 编辑窗体）
```
┌──────────────────────────────┐
│ Verbose: 消息列表（可滚动）  │
│ 1. [system] 你是…            │
│ 2. [user] 请帮我…            │
│ 3. [assistant] 好的…         │
│                              │
├──────────────────────────────┤
│ 选中消息详情/编辑区          │
│ 角色: system/user/assistant  │
│ 内容: （可多行编辑）         │
│ [保存] [删除] [新增]         │
└──────────────────────────────┘
```

**说明**
- 进入 Verbose mode 时右侧边栏自动展开。
- 消息列表支持上下选择；选中后在下半区编辑。
- 支持新增、删除、修改角色与内容。
- 主功能完成后可增强：批量删除、system 模板。
- 通过 `h` 开关右侧栏显示/隐藏，默认仅占位。

#### 3) Debug mode（Advanced）发送前暂停窗体
```
┌──────────────────────────────┐
│ Debug: 请求 JSON 预览/编辑    │
│ {                             │
│   "model": "...",           │
│   "messages": [...],         │
│   "stream": true             │
│ }                             │
│                              │
│ [发送] [取消] [恢复原始]      │
└──────────────────────────────┘
```

**说明**
- 发送前拦截：构造请求后进入 Debug 窗体。
- 允许编辑 JSON；失败则提示并保持在 Debug 窗体。
- 主功能完成后可增强：展示请求 headers、baseUrl、timeouts 等详细信息。
- 通过 `d` 开关 Debug 状态；开启后**任意 runner**在发送请求前都必须弹出预览/编辑对话框。
- Debug 开启状态应在界面上有明确指示（状态栏或显著标记）。

### 二、交互细节（聚焦必须实现的功能）

#### 1) Chat runner
- **消息对齐**：在渲染层实现消息气泡对齐。
- **选择复制**：历史 viewport 允许选择文本并复制（优先实现）。
- **Markdown 渲染**：用户和 assistant 消息统一 Markdown 渲染。
- **滚动**：历史可滚动；输入区保持固定位置。

#### 2) Verbose mode
- **消息编辑**：支持 system/user/assistant 类型修改。
- **增删改**：新增消息插入到当前选中项之后；删除当前选中项。
- **即时生效**：保存后写回 session messages。

#### 3) Debug mode
- **发送前暂停**：构造请求后进入 Debug 窗体。
- **可编辑 JSON**：编辑后尝试解析；失败显示错误。
- **动作按钮**：发送 / 取消 / 恢复原始 JSON。

### 三、对现有代码的影响与前置准备

#### 1) 可能受影响的模块
- TUI 状态与事件流（新增模式与子状态机）：
  - [tui/Oasis/Tui/State.hs](tui/Oasis/Tui/State.hs)
  - [tui/Oasis/Tui/Event.hs](tui/Oasis/Tui/Event.hs)
  - [tui/Oasis/Tui/Actions.hs](tui/Oasis/Tui/Actions.hs)
- Chat 渲染与输出：
  - [tui/Oasis/Tui/Render/Output.hs](tui/Oasis/Tui/Render/Output.hs)
  - [tui/Oasis/Tui/Render/Markdown.hs](tui/Oasis/Tui/Render/Markdown.hs)
- Chat 逻辑与 Runner：
  - [tui/Oasis/Tui/Actions/Chat.hs](tui/Oasis/Tui/Actions/Chat.hs)
  - [src/Oasis/Runner/Chat.hs](src/Oasis/Runner/Chat.hs)

#### 2) 需要提前完成的代码准备（实施方案应体现）
1. **统一消息模型映射**
   - 确认 TUI 的 message 类型与 `Oasis.Chat.Message` 一致或可无损转换。
2. **TUI 状态扩展**
   - 新增 `Mode`/`SubMode` 字段，覆盖：Normal/Verbose/Debug/Edit 等子状态。
3. **会话中断与取消**
   - 增加 request cancel 控制路径（用于 Debug 取消和 Chat 流式停止）。
4. **剪贴板支持**
   - 选择复制依赖系统剪贴板交互，需确认库或系统接口可用（例如 `clipboard`）。
5. **请求拦截点**
   - 在构建 `ChatCompletionRequest` 后、发送前增加 hook，用于 Debug 模式暂停。
6. **消息编辑器组件**
   - 复用现有文本编辑控件或新增可复用的“多行编辑窗体”组件。

### 四、实施方案（分阶段、可验证）

#### 阶段 A：TUI 内部状态与基础渲染准备
1. 扩展 TUI state：新增 mode/subMode；新增 messages 编辑缓冲字段。
2. 对现有 Chat 渲染进行抽象：对齐布局、气泡样式、Markdown 统一入口。

#### 阶段 B：Chat runner 主功能
1. 历史消息 viewport + 输入区固定布局。
2. 消息对齐渲染（左/右对齐）。
3. 选择复制功能（历史 viewport）。
4. 流式更新展示。

#### 阶段 C：Verbose mode
1. 右侧消息列表 + 编辑窗体 UI。
2. 消息增删改、写回 session。
3. 可选增强：批量删除、system 模板。

#### 阶段 D：Debug mode
1. 请求发送前拦截与暂停。
2. JSON 编辑与验证；发送/取消/恢复。
3. 可选增强：更多请求详情展示。

### 五、完成标准
1. Chat runner 支持多轮对话、Markdown 渲染、历史滚动、对齐与选择复制。
2. Verbose mode 支持消息增删改并即时反映到对话历史。
3. Debug mode 能在发送前展示并编辑 JSON，请求可发送或取消。
